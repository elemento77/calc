<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Talent Calculator</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #101723;
      --panel2: #0f1622;
      --line: #243245;
      --text: #e7eefc;
      --muted: #93a4bd;
      --good: #35ff6a;
      --bad: #ff3b3b;
      --warn: #ffd65a;
      --cyan: #32d6ff;
      --shadow: 0 10px 30px rgba(0, 0, 0, .35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: radial-gradient(1200px 700px at 20% 5%, rgba(40, 120, 255, .18), transparent 60%),
        radial-gradient(1000px 650px at 85% 20%, rgba(0, 255, 160, .10), transparent 55%),
        var(--bg);
      color: var(--text);
      font-family: var(--sans);
    }

    .wrap {
      max-width: 1080px;
      margin: 26px auto;
      padding: 0 14px;
    }

    header {
      display: flex;
      gap: 14px;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255, 255, 255, .04), rgba(255, 255, 255, .02));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .leftHead {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .title {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .3px
    }

    .sub {
      color: var(--muted);
      font-size: 13px
    }

    .rightHead {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end
    }

    select,
    button,
    input {
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255, 255, 255, .03);
      color: var(--text);
      padding: 10px 12px;
      font-size: 13px;
      outline: none;
    }

    select {
      min-width: 190px;
      cursor: pointer
    }

    select option {
      background: var(--panel);
      color: var(--text);
    }

    button {
      cursor: pointer;
      transition: .12s transform, .12s opacity;
      font-weight: 700
    }

    button:hover {
      transform: translateY(-1px)
    }

    button:active {
      transform: translateY(0px);
      opacity: .85
    }

    .btnPrimary {
      border-color: rgba(50, 214, 255, .35);
      background: rgba(50, 214, 255, .08)
    }

    .btnGood {
      border-color: rgba(53, 255, 106, .35);
      background: rgba(53, 255, 106, .08)
    }

    .btnBad {
      border-color: rgba(255, 59, 59, .35);
      background: rgba(255, 59, 59, .08)
    }

    .btnWarn {
      border-color: rgba(255, 214, 90, .35);
      background: rgba(255, 214, 90, .08)
    }

    .pill {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0, 0, 0, .20)
    }

    .pill b {
      font-family: var(--mono);
      font-size: 13px
    }

    .pill .good {
      color: var(--good)
    }

    .pill .bad {
      color: var(--bad)
    }

    .pill .warn {
      color: var(--warn)
    }

    .pill .muted {
      color: var(--muted);
      font-weight: normal;
    }

    .headerStats {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .headerStats .pill {
      padding: 6px 10px;
      font-size: 12px;
    }

    .goldIcon {
      width: 20px;
      height: 20px;
      object-fit: contain;
      margin-left: 4px;
    }

    main {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .panel {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .015));
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .panelHead {
      padding: 14px 16px;
      display: flex;
      gap: 10px;
      border-bottom: 1px solid var(--line);
      background: rgba(0, 0, 0, .18);
    }

    .panelHead .h {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .classIcon {
      width: 48px;
      height: 48px;
      object-fit: contain;
      display: none;
      /* Oculto por padrão */
    }

    .panelHead .h .k {
      font-weight: 900;
      letter-spacing: .3px
    }

    .panelHead .h .m {
      font-size: 12px;
      color: var(--muted)
    }

    .panelHead .r {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end
    }

    .skills {
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .skill {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(0, 0, 0, .14));
      padding: 12px 12px;
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 12px;
    }

    @media (max-width: 820px) {
      .skill {
        grid-template-columns: 1fr;
      }
    }

    .skillLeft {
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-right: 1px solid rgba(255, 255, 255, .06);
      padding-right: 12px;
    }

    @media (max-width: 820px) {
      .skillLeft {
        border-right: none;
        padding-right: 0;
        border-bottom: 1px solid rgba(255, 255, 255, .06);
        padding-bottom: 12px;
      }
    }

    .skillTop {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }

    .skillName {
      font-weight: 900;
      letter-spacing: .2px
    }

    .skillMeta {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end
    }

    .badge {
      font-family: var(--mono);
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .03);
      color: var(--muted);
      text-transform: uppercase;
      white-space: nowrap;
    }

    .badge.active {
      color: var(--cyan)
    }

    .badge.passive {
      color: #cfd7ea
    }

    .badge.on {
      color: var(--good);
      border-color: rgba(53, 255, 106, .28);
      background: rgba(53, 255, 106, .06)
    }

    .badge.off {
      color: var(--bad);
      border-color: rgba(255, 59, 59, .28);
      background: rgba(255, 59, 59, .06)
    }

    .levelRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px
    }

    .levelRow .lvl {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .mini {
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 900;
      font-family: var(--mono);
      width: 42px;
      text-align: center;
    }

    .mini:disabled {
      opacity: .4;
      cursor: not-allowed
    }

    .req {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .req b {
      color: var(--warn);
      font-family: var(--mono);
      font-size: 12px
    }

    .skillRight {
      display: flex;
      flex-direction: column;
      gap: 8px;
      justify-content: center;
    }

    .desc {
      font-size: 13px;
      line-height: 1.35;
      color: #eaf1ff;
    }

    .desc .val {
      font-weight: 900;
      font-family: var(--mono)
    }

    .desc .val.good {
      color: var(--good)
    }

    .desc .val.bad {
      color: var(--bad)
    }

    .desc .muted {
      color: var(--muted)
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
    }

    .footerNote {
      padding: 14px 16px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .mono {
      font-family: var(--mono)
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, .75);
      border: 1px solid rgba(255, 255, 255, .12);
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: .18s opacity;
      box-shadow: var(--shadow);
    }

    .toast.show {
      opacity: 1
    }

    /* ===== Mobile Improvements ===== */
    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      .leftHead {
        text-align: center;
      }

      .rightHead {
        justify-content: center;
      }

      .headerStats {
        justify-content: center;
      }

      .panelHead {
        flex-direction: column;
        gap: 12px;
      }

      .panelHead .r {
        justify-content: center;
      }

      .mini {
        width: 48px;
        padding: 10px 12px;
        font-size: 16px;
        /* evita zoom no iOS */
      }

      select,
      button,
      input {
        font-size: 16px;
        /* evita zoom automático no iOS */
      }

      .pill {
        padding: 8px 10px;
      }

      .pill b {
        font-size: 12px;
      }

      .footerNote {
        flex-direction: column;
        text-align: center;
        gap: 6px;
      }

      .toast {
        left: 14px;
        right: 14px;
        transform: none;
        text-align: center;
      }
    }

    /* Header sticky para melhor navegação */
    header {
      position: sticky;
      top: 14px;
      z-index: 100;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="leftHead">
        <div class="title">Talent Calculator</div>
        <div class="headerStats">
          <div class="pill">
            <span>Pontos</span>
            <b id="headerPointsSpent" class="good">0</b>
            <span class="muted">/</span>
            <b>60</b>
          </div>
          <div class="pill">
            <span>Gold</span>
            <b id="headerGold" class="warn">0gp</b>
            <img src="gold_pile_transparent.png" alt="gold" class="goldIcon">
          </div>
        </div>
      </div>
      <div class="rightHead">
        <select id="classSelect" aria-label="Classe">
          <option value="ranger">Ranger</option>
          <option value="barbarian">Barbarian</option>
          <option value="necromancer">Necromancer</option>
          <option value="wizard">Wizard</option>
          <option value="paladin">Paladin</option>
        </select>

        <button class="btnWarn" id="resetBtn">Reset</button>
        <button class="btnGood" id="exportBtn">Export</button>
        <button class="btnPrimary" id="importBtn">Import</button>
      </div>
    </header>

    <main>
      <section class="panel">
        <div class="panelHead">
          <img id="classIcon" class="classIcon" alt="class icon">
          <div class="h">
            <div class="k" id="classTitle">Ranger</div>
            <div class="m">Distribua seus pontos e compartilhe a build.</div>
          </div>
        </div>

        <div class="skills" id="skills"></div>

        <div class="footerNote">
          <span><b>CD Shard</b></span>
          <span>Ajuste seus pontos, compartilhe sua build e domine o servidor brasileiro mais inovador de UO.</span>
        </div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* =========================
       Helpers
    ========================= */
    const TOTAL_POINTS = 60;

    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }
    function fmt0(n) { return (Math.round(n)).toString(); }
    function fmt1(n) { return (Math.round(n * 10) / 10).toFixed(1); }
    function lerp(a, b, t) { return a + (b - a) * t; }
    function piecewise(L, points) {
      if (L <= points[0].l) return points[0].v;
      for (let i = 0; i < points.length - 1; i++) {
        const A = points[i], B = points[i + 1];
        if (L <= B.l) {
          const t = (L - A.l) / (B.l - A.l);
          return lerp(A.v, B.v, t);
        }
      }
      return points[points.length - 1].v;
    }
    // valor destacado: 0 => vermelho, >0 => verde
    function v(level, text) {
      const cls = level > 0 ? "good" : "bad";
      return `<span class="val ${cls}">${text}</span>`;
    }
    function displayLevel(L0) { return clamp(L0, 0, 15); }

    function showToast(msg) {
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(() => el.classList.remove("show"), 1600);
    }

    function classPrefix(key) {
      if (key === "barbarian") return "b";
      if (key === "necromancer") return "n";
      if (key === "wizard") return "w";
      if (key === "paladin") return "p";
      return "r"; // ranger
    }
    function keyFromPrefix(p) {
      if (p === "b") return "barbarian";
      if (p === "n") return "necromancer";
      if (p === "w") return "wizard";
      if (p === "p") return "paladin";
      return "ranger";
    }

    function encodeLevelsToHex(levels, skills) {
      // 4 bits per skill (0-15). Two skills per byte => hex string.
      const bytes = [];
      for (let i = 0; i < skills.length; i += 2) {
        const a = clamp(levels[skills[i].id] ?? 0, 0, 15);
        const b = (i + 1 < skills.length) ? clamp(levels[skills[i + 1].id] ?? 0, 0, 15) : 0;
        bytes.push(((a & 0xF) << 4) | (b & 0xF));
      }
      return bytes.map(x => x.toString(16).padStart(2, '0')).join('');
    }
    function decodeHexToLevels(hex, skills) {
      const out = {};
      const bytes = [];
      for (let i = 0; i < hex.length; i += 2) {
        const s = hex.slice(i, i + 2);
        if (!/^[0-9a-fA-F]{2}$/.test(s)) break;
        bytes.push(parseInt(s, 16));
      }
      let si = 0;
      for (let bi = 0; bi < bytes.length && si < skills.length; bi++) {
        const a = (bytes[bi] >> 4) & 0xF;
        const b = bytes[bi] & 0xF;
        out[skills[si].id] = a; si++;
        if (si < skills.length) { out[skills[si].id] = b; si++; }
      }
      // default missing to 0
      for (const s of skills) {
        if (out[s.id] == null) out[s.id] = 0;
      }
      return out;
    }

    function pointsSpent(levels, skills) {
      let sum = 0;
      for (const s of skills) sum += clamp(levels[s.id] ?? 0, 0, s.max);
      return sum;
    }

    function goldSpent(levels, skills) {
      let sum = 0;
      for (const s of skills) {
        const L = clamp(levels[s.id] ?? 0, 0, s.max);
        sum += L * (s.cost || 0);
      }
      return sum;
    }

    /* =========================
       Class-specific helpers
    ========================= */
    // Paladin tiles breakpoint: 0-2:7 | 3-5:8 | 6-8:9 | 9-11:10 | 12-14:11 | 15:12
    function paladinTiles(L) {
      if (L >= 15) return 12;
      if (L >= 12) return 11;
      if (L >= 9) return 10;
      if (L >= 6) return 9;
      if (L >= 3) return 8;
      return 7;
    }
    // Necro Soul Syphon range breakpoint: 8@3, 9@6, 10@9, 11@12, 12@15 (assumindo 7 antes de 3)
    function necroSyphonRange(L) {
      if (L >= 15) return 12;
      if (L >= 12) return 11;
      if (L >= 9) return 10;
      if (L >= 6) return 9;
      if (L >= 3) return 8;
      return 7;
    }

    /* =========================
       DATA — CLASSES (final atualizado)
    ========================= */

    // ===== RANGER =====
    const RANGER = {
      key: "ranger",
      label: "Ranger",
      skills: [
        {
          id: "sharpshooter", name: "Sharpshooter", type: "PASSIVE", max: 15, cost: 100, req: "Ranged Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const tiles = piecewise(L, [{ l: 1, v: 0 }, { l: 5, v: 1 }, { l: 10, v: 2 }, { l: 15, v: 3 }]);
            const bonus = piecewise(L, [{ l: 1, v: 16 }, { l: 5, v: 40 }, { l: 10, v: 70 }, { l: 15, v: 100 }]);
            return `Increases attacks range by ${v(L0, "+" + fmt0(tiles))} tiles. Deals up to ${v(L0, fmt0(bonus) + "%")} bonus damage based on distance.`;
          }
        },
        {
          id: "spirit_wolf", name: "Spirit Wolf", type: "ACTIVE 1", max: 15, cost: 100, req: "Ranged Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const hp = piecewise(L, [{ l: 1, v: 92 }, { l: 5, v: 140 }, { l: 10, v: 200 }, { l: 15, v: 260 }]);
            return `Summons a Spirit Wolf with ${v(L0, fmt0(hp) + " HP")}. Active Use: Using the skill again commands the wolf to Taunt all nearby enemies and heals the wolf.`;
          }
        },
        {
          id: "hunters_mark", name: "Hunter's Mark", type: "PASSIVE", max: 15, cost: 200, req: "Ranged Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const chance = piecewise(L, [{ l: 1, v: 6.5 }, { l: 5, v: 12.5 }, { l: 10, v: 20 }, { l: 15, v: 27.5 }]);
            const resist = piecewise(L, [{ l: 1, v: 6 }, { l: 5, v: 10 }, { l: 10, v: 15 }, { l: 15, v: 20 }]);
            const rf = piecewise(L, [{ l: 1, v: 8 }, { l: 5, v: 20 }, { l: 10, v: 35 }, { l: 15, v: 50 }]);
            const dmg = piecewise(L, [{ l: 1, v: 1 }, { l: 5, v: 5 }, { l: 10, v: 10 }, { l: 15, v: 15 }]);
            return `${v(L0, fmt1(chance) + "%")} chance to Mark targets, reducing all resistances by ${v(L0, fmt0(resist) + "%")} for 3.0s. Hitting Marked targets has ${v(L0, fmt0(rf) + "%")} chance to trigger Rapid Fire and deal ${v(L0, fmt0(dmg))} bonus damage.`;
          }
        },
        {
          id: "sniper_shot", name: "Sniper Shot", type: "ACTIVE 2", max: 15, cost: 300, req: "Ranged Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const dmg = (L <= 0) ? 150 : (160 + (L - 1) * 10);
            const stun = piecewise(L, [{ l: 1, v: 2.2 }, { l: 5, v: 3.0 }, { l: 10, v: 4.0 }, { l: 15, v: 5.0 }]);
            return `Channels your focus into a single, devastating shot dealing ${v(L0, fmt0(dmg) + "%")} weapon max damage. The sheer kinetic force knocks the enemy back and leaves them stunned for ${v(L0, fmt1(stun) + "s")}. Moving cancels.`;
          }
        },
        {
          id: "vampiric_arrows", name: "Vampiric Arrows", type: "PASSIVE", max: 15, cost: 400, req: "Ranged Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const heal = piecewise(L, [{ l: 1, v: 6 }, { l: 5, v: 10 }, { l: 10, v: 15 }, { l: 15, v: 20 }]);
            return `Drains vitality from targets, healing you for ${v(L0, fmt0(heal) + "%")} of the damage dealt.`;
          }
        },
        {
          id: "triple_ricochet", name: "Triple Ricochet", type: "ACTIVE 3", max: 15, cost: 500, req: "Ranged Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const dmg = piecewise(L, [{ l: 1, v: 55 }, { l: 5, v: 75 }, { l: 10, v: 100 }, { l: 15, v: 125 }]);
            return `Fires 3 shots, each dealing ${v(L0, fmt0(dmg) + "%")} weapon damage. Ricochets to enemies within 5 tiles.`;
          }
        },
        {
          id: "frost_arrows", name: "Frost Arrows", type: "PASSIVE", max: 15, cost: 600, req: "Ranged Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const conv = piecewise(L, [{ l: 1, v: 16 }, { l: 5, v: 40 }, { l: 10, v: 70 }, { l: 15, v: 100 }]);
            const slow = piecewise(L, [{ l: 1, v: 33 }, { l: 5, v: 45 }, { l: 10, v: 60 }, { l: 15, v: 75 }]);
            return `Converts ${v(L0, fmt0(conv) + "%")} of ranged physical damage to cold. Slows enemy movement by ${v(L0, fmt0(slow) + "%")} for 2.0s.`;
          }
        },
        {
          id: "rain_of_arrows", name: "Rain of Arrows", type: "ACTIVE 4", max: 15, cost: 700, req: "Ranged Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const dur = piecewise(L, [{ l: 1, v: 3.2 }, { l: 5, v: 4.0 }, { l: 10, v: 5.0 }, { l: 15, v: 6.0 }]);
            const dps = piecewise(L, [{ l: 1, v: 32 }, { l: 5, v: 40 }, { l: 10, v: 50 }, { l: 15, v: 60 }]);
            return `Rain arrows on a 5-tile radius area for ${v(L0, fmt1(dur) + "s")} dealing ${v(L0, fmt0(dps) + "%")} weapon damage per second.`;
          }
        },
      ]
    };

    // ===== BARBARIAN =====
    const BARBARIAN = {
      key: "barbarian",
      label: "Barbarian",
      skills: [
        {
          id: "berserkers_blood", name: "Berserker's Blood", type: "PASSIVE", max: 15, cost: 100, req: "2H Melee Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const spd = piecewise(L, [{ l: 1, v: 110 }, { l: 5, v: 150 }, { l: 10, v: 200 }, { l: 15, v: 250 }]);
            const hp = piecewise(L, [{ l: 1, v: 18 }, { l: 5, v: 30 }, { l: 10, v: 45 }, { l: 15, v: 60 }]);
            return `Increases Attack Speed up to ${v(L0, fmt0(spd) + "%")}, reaching max effect at ${v(L0, fmt0(hp) + "%")} Health.`;
          }
        },
        {
          id: "savage_regrowth", name: "Savage Regrowth", type: "ACTIVE 1", max: 15, cost: 100, req: "2H Melee Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const regen = piecewise(L, [{ l: 1, v: 3 }, { l: 5, v: 11 }, { l: 10, v: 21 }, { l: 15, v: 31 }]);
            return `Activates below 70% Health. Regenerates up to ${v(L0, fmt0(regen) + "%")} max health based on missing HP. Cost: 1 Mana/sec while healing.`;
          }
        },
        {
          id: "primal_strength", name: "Primal Strength", type: "PASSIVE", max: 15, cost: 200, req: "2H Melee Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const dmg = piecewise(L, [{ l: 1, v: 10 }, { l: 5, v: 50 }, { l: 10, v: 100 }, { l: 15, v: 150 }]);
            const hp = piecewise(L, [{ l: 1, v: 18 }, { l: 5, v: 30 }, { l: 10, v: 45 }, { l: 15, v: 60 }]);
            return `Deals up to ${v(L0, fmt0(dmg) + "%")} bonus weapon damage, reaching max effect at ${v(L0, fmt0(hp) + "%")} Health.`;
          }
        },
        {
          id: "burning_blood", name: "Burning Blood", type: "ACTIVE 2", max: 15, cost: 300, req: "2H Melee Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const extra = piecewise(L, [{ l: 1, v: 5 }, { l: 5, v: 25 }, { l: 10, v: 50 }, { l: 15, v: 75 }]);
            return `Every attack consume 1 HP on hit and deals ${v(L0, fmt0(extra) + "%")} extra fire damage to the target and nearby enemies (AoE).`;
          }
        },
        {
          id: "brutal_strike", name: "Brutal Strike", type: "PASSIVE", max: 15, cost: 400, req: "2H Melee Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const chance = piecewise(L, [{ l: 1, v: 3 }, { l: 5, v: 15 }, { l: 10, v: 30 }, { l: 15, v: 45 }]);
            const dmg = piecewise(L, [{ l: 1, v: 1 }, { l: 5, v: 5 }, { l: 10, v: 10 }, { l: 15, v: 15 }]);
            return `Attacks have a ${v(L0, fmt0(chance) + "%")} chance to dealing ${v(L0, fmt0(dmg))} bonus damage and STUN the target for 1.5s.`;
          }
        },
        {
          id: "undying_rage", name: "Undying Rage", type: "ACTIVE 3", max: 15, cost: 500, req: "2H Melee Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const cd = piecewise(L, [{ l: 1, v: 172 }, { l: 5, v: 140 }, { l: 10, v: 100 }, { l: 15, v: 60 }]);
            return `Immune to damage and DOUBLE weapon and pvm skills damage for 10 seconds. Cooldown: ${v(L0, fmt0(cd) + " seconds")}.`;
          }
        },
        {
          id: "primal_resistance", name: "Primal Resistance", type: "PASSIVE", max: 15, cost: 600, req: "2H Melee Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const red = piecewise(L, [{ l: 1, v: 2 }, { l: 5, v: 10 }, { l: 10, v: 20 }, { l: 15, v: 30 }]);
            return `Reduces incoming non-physical damage by ${v(L0, fmt0(red) + "%")}.`;
          }
        },
        {
          id: "leap_attack", name: "Leap Attack", type: "ACTIVE 4", max: 15, cost: 700, req: "2H Melee Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const dmg = piecewise(L, [{ l: 1, v: 60 }, { l: 5, v: 100 }, { l: 10, v: 150 }, { l: 15, v: 200 }]);
            const cd = piecewise(L, [{ l: 1, v: 24 }, { l: 5, v: 20 }, { l: 10, v: 15 }, { l: 15, v: 10 }]);
            return `Leap to location causing impact damage and burning enemies for 5s. Total Damage: ${v(L0, fmt0(dmg) + "%")} weapon max damage. Stuns for 2.0s. Cost: 30% Current HP. Cooldown: ${v(L0, fmt0(cd) + "s")}.`;
          }
        },
      ]
    };

    // ===== NECROMANCER =====
    const NECROMANCER = {
      key: "necromancer",
      label: "Necromancer",
      skills: [
        {
          id: "raise_dead", name: "Raise Dead", type: "PASSIVE", max: 15, cost: 100, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const chance = piecewise(L, [{ l: 1, v: 16 }, { l: 5, v: 20 }, { l: 10, v: 25 }, { l: 15, v: 30 }]);
            const tiers = [
              { l: 1, name: "Headless One" },
              { l: 2, name: "Zombie" },
              { l: 3, name: "Skeleton" },
              { l: 5, name: "Skeleton Archer" },
              { l: 7, name: "Skeleton Mage" },
              { l: 9, name: "Bone Magi" },
              { l: 11, name: "Patchwork Skeleton" },
              { l: 13, name: "Skeletal Knight" },
              { l: 15, name: "Skeletal Dragon" },
            ];
            const unlocked = tiers.filter(t => L >= t.l).map(t => t.name);
            const list = unlocked.length ? unlocked.join(", ") : "—";
            const extra = (L >= 15) ? ` At level 15 has a ${v(L0, "20%")} chance to Reanimate victims on kill.` : "";
            return `Dealing damage have ${v(L0, fmt1(chance) + "%")} chance to summon undead.${extra} <span class="muted">Summon list scales with skill level:</span> ${v(L0, list)}`;
          }
        },
        {
          id: "soul_syphon", name: "Soul Syphon", type: "ACTIVE 1", max: 15, cost: 100, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const dmg = piecewise(L, [{ l: 1, v: 85 }, { l: 5, v: 105 }, { l: 10, v: 130 }, { l: 15, v: 155 }]);
            const range = necroSyphonRange(L);
            return `Deals ${v(L0, fmt0(dmg) + "%")} Staff Dmg to 3 closest enemies at range ${v(L0, fmt0(range))} and heals you. Passively allows range ${v(L0, fmt0(range))} on staff attacks & spellcasting with staffs (PvM).`;
          }
        },
        {
          id: "necrotic_curse", name: "Necrotic Curse", type: "PASSIVE", max: 15, cost: 200, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const chance = piecewise(L, [{ l: 1, v: 18 }, { l: 5, v: 30 }, { l: 10, v: 45 }, { l: 15, v: 60 }]);
            const red = piecewise(L, [{ l: 1, v: 7 }, { l: 5, v: 15 }, { l: 10, v: 25 }, { l: 15, v: 35 }]);
            const dur = piecewise(L, [{ l: 1, v: 5.5 }, { l: 5, v: 7.5 }, { l: 10, v: 10.0 }, { l: 15, v: 12.5 }]);
            return `${v(L0, fmt0(chance) + "%")} Chance to reduce physical & poison resistance on attacks by ${v(L0, fmt0(red) + "%")} for ${v(L0, fmt1(dur) + "s")}.`;
          }
        },
        {
          id: "grasp_dead", name: "Grasp of the Dead", type: "ACTIVE 2", max: 15, cost: 300, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const dur = piecewise(L, [{ l: 1, v: 2.4 }, { l: 5, v: 4.0 }, { l: 10, v: 6.0 }, { l: 15, v: 8.0 }]);
            const dmg = piecewise(L, [{ l: 1, v: 52 }, { l: 5, v: 60 }, { l: 10, v: 70 }, { l: 15, v: 80 }]);
            return `Summons bones for ${v(L0, fmt1(dur) + "s")}. Enemies inside or entering the area are Rooted and take ${v(L0, fmt0(dmg) + "%")} staff physical damage.`;
          }
        },
        {
          id: "minion_explosion", name: "Minion Explosion", type: "PASSIVE", max: 15, cost: 400, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const pct = piecewise(L, [{ l: 1, v: 6 }, { l: 5, v: 10 }, { l: 10, v: 15 }, { l: 15, v: 20 }]);
            return `When your army is full, the weakest minion moves to the target and explodes. Deals ${v(L0, fmt0(pct) + "%")} of its Max HP as poison damage to nearby enemies.`;
          }
        },
        {
          id: "blood_storm", name: "Blood Storm", type: "ACTIVE 3", max: 15, cost: 500, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const drain = piecewise(L, [{ l: 1, v: 15 }, { l: 5, v: 11 }, { l: 10, v: 6 }, { l: 15, v: 1 }]);
            const flat = piecewise(L, [{ l: 1, v: 1 }, { l: 5, v: 5 }, { l: 10, v: 10 }, { l: 15, v: 15 }]);
            const heal = piecewise(L, [{ l: 1, v: 2 }, { l: 5, v: 6 }, { l: 10, v: 11 }, { l: 15, v: 16 }]);
            return `Drains ${v(L0, fmt0(drain) + "%")} of your current HP per tick. Each tick deals ${v(L0, fmt0(flat))} damage as physical damage and heals your minions for ${v(L0, fmt0(heal) + "%")} of their max HP.`;
          }
        },
        {
          id: "undead_mastery", name: "Undead Mastery", type: "PASSIVE", max: 15, cost: 600, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const hp = piecewise(L, [{ l: 1, v: 3 }, { l: 5, v: 15 }, { l: 10, v: 30 }, { l: 15, v: 45 }]);
            const dmg = piecewise(L, [{ l: 1, v: 2 }, { l: 5, v: 10 }, { l: 10, v: 20 }, { l: 15, v: 30 }]);
            return `Minions gain ${v(L0, fmt0(hp))} Max HP and deal ${v(L0, fmt0(dmg))} bonus damage.`;
          }
        },
        {
          id: "long_night", name: "The Long Night", type: "ACTIVE 4", max: 15, cost: 700, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const dps = piecewise(L, [{ l: 1, v: 52 }, { l: 5, v: 80 }, { l: 10, v: 115 }, { l: 15, v: 150 }]);
            const cd = piecewise(L, [{ l: 1, v: 285 }, { l: 5, v: 225 }, { l: 10, v: 150 }, { l: 15, v: 75 }]);
            return `Manifest the Night King form for 10s. Every second, deals ${v(L0, fmt0(dps) + "%")} Staff Max Dmg as Cold and Freezes enemies within 10 tiles. Each hit heals you for 50% of total damage dealt. Cooldown: ${v(L0, fmt0(cd) + "s")}.`;
          }
        },
      ]
    };

    // ===== WIZARD =====
    const WIZARD = {
      key: "wizard",
      label: "Wizard",
      skills: [
        {
          id: "arcane_synergy", name: "Arcane Synergy", type: "PASSIVE", max: 15, cost: 100, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const amp = piecewise(L, [{ l: 1, v: 6 }, { l: 5, v: 33 }, { l: 6, v: 40 }, { l: 12, v: 80 }, { l: 15, v: 100 }]);
            return `Amplify Magery spells damage: ${v(L0, "+" + fmt0(amp) + "%")}. Passively allows range 12 on staff attacks & spellcasting with staffs (PvM).`;
          }
        },
        {
          id: "mystic_bolt", name: "Mystic Bolt", type: "ACTIVE 1", max: 15, cost: 100, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            // fix final: 7 bounces @15, restore 4 mana @15
            const bounces = Math.min(7, 2 + Math.floor(L / 3)); // 2@1, 3@3, 4@6, 6@12, 7@15
            const mana = Math.min(4, 1 + Math.floor(L / 5)); // 1@1, 2@5, 3@10, 4@15
            const dmg = piecewise(L, [{ l: 1, v: 2 }, { l: 3, v: 4 }, { l: 6, v: 7 }, { l: 12, v: 13 }, { l: 15, v: 15 }]);
            return `Bounces up to ${v(L0, fmt0(bounces))} times. Deals ${v(L0, fmt0(dmg))} energy damage per hit. Restores ${v(L0, fmt0(mana))} mana per bounce.`;
          }
        },
        {
          id: "arcane_overload", name: "Arcane Overload", type: "PASSIVE", max: 15, cost: 200, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const ele = piecewise(L, [{ l: 1, v: 7 }, { l: 5, v: 15 }, { l: 6, v: 17 }, { l: 12, v: 29 }, { l: 15, v: 35 }]);
            return `Increases Elemental Damage by ${v(L0, fmt0(ele) + "%")}.`;
          }
        },
        {
          id: "mana_ward", name: "Mana Ward", type: "ACTIVE 2", max: 15, cost: 300, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const abs = piecewise(L, [{ l: 1, v: 23 }, { l: 5, v: 35 }, { l: 6, v: 38 }, { l: 12, v: 56 }, { l: 15, v: 65 }]);
            return `Absorbs up to ${v(L0, fmt0(abs) + "%")} of damage. Mana Cost depends on Armor Weight (The lighter, the better).`;
          }
        },
        {
          id: "arcane_conductivity", name: "Arcane Conductivity", type: "PASSIVE", max: 15, cost: 400, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const red = piecewise(L, [{ l: 1, v: 13 }, { l: 3, v: 19 }, { l: 5, v: 25 }, { l: 6, v: 28 }, { l: 12, v: 46 }, { l: 15, v: 55 }]);
            return `Reduces Spell Delay by ${v(L0, fmt0(red) + "%")} when wearing Light Armor.`;
          }
        },
        {
          id: "mirror_image", name: "Mirror Image", type: "ACTIVE 3", max: 15, cost: 500, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const clones = piecewise(L, [{ l: 1, v: 1 }, { l: 5, v: 2 }, { l: 12, v: 2 }, { l: 15, v: 3 }]);
            const stats = piecewise(L, [{ l: 1, v: 53 }, { l: 3, v: 60 }, { l: 5, v: 66 }, { l: 6, v: 70 }, { l: 12, v: 90 }, { l: 15, v: 100 }]);
            const mana = piecewise(L, [{ l: 1, v: 6 }, { l: 3, v: 8 }, { l: 5, v: 10 }, { l: 6, v: 11 }, { l: 12, v: 17 }, { l: 15, v: 20 }]);
            return `Summons ${v(L0, fmt0(clones))} Clones for 30s. Clones have ${v(L0, fmt0(stats) + "%")} of your stats/skills and restore ${v(L0, fmt0(mana) + "%")} of their damage as mana to you.`;
          }
        },
        {
          id: "elemental_erosion", name: "Elemental Erosion", type: "PASSIVE", max: 15, cost: 600, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const maxRes = piecewise(L, [{ l: 1, v: 3 }, { l: 3, v: 9 }, { l: 5, v: 15 }, { l: 6, v: 18 }, { l: 12, v: 36 }, { l: 15, v: 45 }]);
            return `Magery spells reduce the target's resistance to their element by the amount of damage dealt (Max ${v(L0, "-" + fmt0(maxRes) + " resist")}) for 4.0s.`;
          }
        },
        {
          id: "disintegrate", name: "Disintegrate", type: "ACTIVE 4", max: 15, cost: 700, req: "Staff Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const upTo = piecewise(L, [{ l: 1, v: 1 }, { l: 3, v: 3 }, { l: 5, v: 5 }, { l: 6, v: 6 }, { l: 12, v: 12 }, { l: 15, v: 15 }]);
            return `Channel a fire that deals initial 1 damage, increasing over time up to ${v(L0, fmt0(upTo))}. Consumes mana rapidly. Moving cancels.`;
          }
        },
      ]
    };

    // ===== PALADIN =====
    const PALADIN = {
      key: "paladin",
      label: "Paladin",
      skills: [
        {
          id: "vanguards_shield", name: "Vanguard's Shield", type: "PASSIVE", max: 15, cost: 100, req: "Shield Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const mit = piecewise(L, [
              { l: 1, v: 1.15 },
              { l: 5, v: 1.75 },
              { l: 10, v: 2.50 },
              { l: 12, v: 2.80 },
              { l: 15, v: 3.25 },
            ]);
            const reflect = piecewise(L, [
              { l: 1, v: 1 },
              { l: 5, v: 5 },
              { l: 10, v: 10 },
              { l: 12, v: 12 },
              { l: 15, v: 15 },
            ]);
            return `Shield mitigation increased by ${v(L0, mit.toFixed(2) + "x")}. Reflects ${v(L0, fmt0(reflect))} Energy damage on hit.`;
          }
        },
        {
          id: "provoking_shout", name: "Provoking Shout", type: "ACTIVE 1", max: 15, cost: 100, req: "Shield Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const tiles = paladinTiles(L);
            const threat = piecewise(L, [
              { l: 1, v: 40 },
              { l: 5, v: 100 },
              { l: 10, v: 175 },
              { l: 12, v: 205 },
              { l: 15, v: 250 },
            ]);
            return `Unleash a mighty roar within ${v(L0, fmt0(tiles))} tiles, challenging all nearby enemies and generating ${v(L0, fmt0(threat))} Threat.`;
          }
        },
        {
          id: "divine_challenge", name: "Divine Challenge", type: "PASSIVE", max: 15, cost: 200, req: "Shield Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const reduce = piecewise(L, [
              { l: 1, v: 2 },
              { l: 5, v: 10 },
              { l: 10, v: 20 },
              { l: 12, v: 24 },
              { l: 15, v: 30 },
            ]);
            return `Reduces all damage received from your current combat target by ${v(L0, fmt0(reduce) + "%")}.`;
          }
        },
        {
          id: "purification", name: "Purification", type: "ACTIVE 2", max: 15, cost: 300, req: "1H Melee Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const heal = piecewise(L, [
              { l: 1, v: 55 },
              { l: 5, v: 75 },
              { l: 10, v: 100 },
              { l: 12, v: 110 },
              { l: 15, v: 125 },
            ]);
            return `Call upon divine light to heal the target for ${v(L0, fmt0(heal) + "%")} weapon max power, scorching adjacent enemies with equal energy damage.`;
          }
        },
        {
          id: "divine_intervention", name: "Divine Intervention", type: "PASSIVE", max: 15, cost: 400, req: "Shield Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const dur = piecewise(L, [
              { l: 1, v: 3.8 },
              { l: 5, v: 5.0 },
              { l: 10, v: 6.5 },
              { l: 12, v: 7.1 },
              { l: 15, v: 8.0 },
            ]);
            const cd = piecewise(L, [
              { l: 1, v: 228 },
              { l: 5, v: 180 },
              { l: 10, v: 120 },
              { l: 12, v: 96 },
              { l: 15, v: 60 },
            ]);
            return `When a party member takes fatal damage, prevents death and convert all damage to heal for ${v(L0, fmt1(dur) + "s")}. Cooldown: ${v(L0, fmt0(cd) + "s")}.`;
          }
        },
        {
          id: "guardian_angel", name: "Guardian Angel", type: "ACTIVE 3", max: 15, cost: 500, req: "1H Melee Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const tiles = paladinTiles(L);
            const dmg = piecewise(L, [
              { l: 1, v: 8 },
              { l: 5, v: 20 },
              { l: 10, v: 35 },
              { l: 12, v: 41 },
              { l: 15, v: 50 },
            ]);
            return `Transform into a Holy Avatar. Holy waves converge on you from ${v(L0, fmt0(tiles))} tiles away, pulling enemies closer and dealing ${v(L0, fmt0(dmg) + "%")} weapon power as energy damage. Drains Mana over time. Allows passing through enemies.`;
          }
        },
        {
          id: "righteous_fury", name: "Righteous Fury", type: "PASSIVE", max: 15, cost: 600, req: "1H Melee Weap",
          describe: (L0) => {
            const L = displayLevel(L0);
            const dmg = piecewise(L, [
              { l: 1, v: 16 },
              { l: 5, v: 40 },
              { l: 10, v: 70 },
              { l: 12, v: 82 },
              { l: 15, v: 100 },
            ]);
            const threatRed = piecewise(L, [
              { l: 1, v: 8 },
              { l: 5, v: 20 },
              { l: 10, v: 35 },
              { l: 12, v: 41 },
              { l: 15, v: 50 },
            ]);
            return `Increases Damage by ${v(L0, fmt0(dmg) + "%")} and reduces threat generation by ${v(L0, fmt0(threatRed) + "%")}.`;
          }
        },
        {
          id: "shield_bash", name: "Shield Bash", type: "ACTIVE 4", max: 15, cost: 700, req: "Shield Equipped",
          describe: (L0) => {
            const L = displayLevel(L0);
            const dmg = piecewise(L, [
              { l: 1, v: 90 },
              { l: 5, v: 150 },
              { l: 10, v: 225 },
              { l: 12, v: 255 },
              { l: 15, v: 300 },
            ]);
            return `Charges forward up to 10 tiles, collecting enemies. Deals ${v(L0, fmt0(dmg) + "%")} of shield physical resist as damage. Wall Slam: Damage is DOUBLED if enemies hit an obstacle.`;
          }
        },
      ]
    };

    const CLASSES = {
      ranger: RANGER,
      barbarian: BARBARIAN,
      necromancer: NECROMANCER,
      wizard: WIZARD,
      paladin: PALADIN,
    };

    /* =========================
       State
    ========================= */
    let currentClassKey = "ranger";
    let levelsByClass = {
      ranger: Object.fromEntries(RANGER.skills.map(s => [s.id, 0])),
      barbarian: Object.fromEntries(BARBARIAN.skills.map(s => [s.id, 0])),
      necromancer: Object.fromEntries(NECROMANCER.skills.map(s => [s.id, 0])),
      wizard: Object.fromEntries(WIZARD.skills.map(s => [s.id, 0])),
      paladin: Object.fromEntries(PALADIN.skills.map(s => [s.id, 0])),
    };

    /* =========================
       Render
    ========================= */
    function updateHeader() {
      const cls = CLASSES[currentClassKey];
      document.getElementById("classTitle").textContent = cls.label;

      // Class Icon Logic
      const iconEl = document.getElementById("classIcon");
      if (currentClassKey === 'barbarian') {
        iconEl.src = "barbicone.png";
        iconEl.style.display = "block";
      } else if (currentClassKey === 'paladin') {
        iconEl.src = "paladinoIcone.png";
        iconEl.style.display = "block";
      } else if (currentClassKey === 'ranger') {
        iconEl.src = "rangericone.png";
        iconEl.style.display = "block";
      } else if (currentClassKey === 'necromancer') {
        iconEl.src = "necroicone.png";
        iconEl.style.display = "block";
      } else if (currentClassKey === 'wizard') {
        iconEl.src = "Wizardicone.png";
        iconEl.style.display = "block";
      } else {
        iconEl.style.display = "none";
      }

      const spent = pointsSpent(levelsByClass[currentClassKey], cls.skills);
      const left = TOTAL_POINTS - spent;
      const gold = goldSpent(levelsByClass[currentClassKey], cls.skills);

      // Atualiza o header sticky
      const headerPointsSpent = document.getElementById("headerPointsSpent");
      headerPointsSpent.textContent = spent.toString();
      headerPointsSpent.className = (left >= 0 ? "good" : "bad");
      document.getElementById("headerGold").textContent = gold.toLocaleString() + "gp";
    }

    function renderSkills() {
      const cls = CLASSES[currentClassKey];
      const levels = levelsByClass[currentClassKey];
      const container = document.getElementById("skills");
      container.innerHTML = "";

      const spent = pointsSpent(levels, cls.skills);
      const left = TOTAL_POINTS - spent;

      for (const sk of cls.skills) {
        const L0 = clamp(levels[sk.id] ?? 0, 0, sk.max);
        const isOn = L0 > 0;

        const skillEl = document.createElement("div");
        skillEl.className = "skill";

        const badgeType = (sk.type || "").toLowerCase().includes("active") ? "active" : "passive";
        const onOff = isOn ? "on" : "off";

        const canMinus = L0 > 0;
        const canPlus = (L0 < sk.max) && (left > 0);

        skillEl.innerHTML = `
      <div class="skillLeft">
        <div class="skillTop">
          <div>
            <div class="skillName" style="color:${isOn ? "var(--good)" : "var(--bad)"}">${sk.name}</div>
          </div>
          <div class="skillMeta">
            <div class="badge ${badgeType}">${sk.type}</div>
          </div>
        </div>

        <div class="levelRow">
          <div class="lvl">Level: <b>${L0}</b> / <b>${sk.max}</b></div>
          <div class="controls">
            <button class="mini btnBad" ${canMinus ? "" : "disabled"} data-act="minus" data-skill="${sk.id}">-</button>
            <button class="mini btnGood" ${canPlus ? "" : "disabled"} data-act="plus" data-skill="${sk.id}">+</button>
          </div>
        </div>

        <div class="req">
          <div><b>Upgrade:</b> <span class="mono">${sk.cost}gp</span></div>
          <div><b>Requirement:</b> <span class="mono">${sk.req}</span></div>
        </div>
      </div>

      <div class="skillRight">
        <div class="desc">${sk.describe(L0)}</div>
      </div>
    `;

        container.appendChild(skillEl);
      }

      // bind buttons
      container.querySelectorAll("button[data-act]").forEach(btn => {
        btn.addEventListener("click", () => {
          const act = btn.getAttribute("data-act");
          const skillId = btn.getAttribute("data-skill");
          if (!act || !skillId) return;
          if (act === "minus") changeLevel(skillId, -1);
          if (act === "plus") changeLevel(skillId, +1);
        });
      });
    }

    function changeLevel(skillId, delta) {
      const cls = CLASSES[currentClassKey];
      const levels = levelsByClass[currentClassKey];

      const sk = cls.skills.find(s => s.id === skillId);
      if (!sk) return;

      const before = clamp(levels[skillId] ?? 0, 0, sk.max);
      const spent = pointsSpent(levels, cls.skills);
      const left = TOTAL_POINTS - spent;

      if (delta > 0 && left <= 0) return;
      const after = clamp(before + delta, 0, sk.max);
      if (after === before) return;

      levels[skillId] = after;

      updateHeader();
      renderSkills();
      syncHash();
      persistLocal();
    }

    function resetCurrent() {
      const cls = CLASSES[currentClassKey];
      const levels = levelsByClass[currentClassKey];
      for (const s of cls.skills) levels[s.id] = 0;
      updateHeader();
      renderSkills();
      syncHash();
      persistLocal();
    }

    /* =========================
       Export / Import
    ========================= */
    function getShareCode() {
      const cls = CLASSES[currentClassKey];
      const levels = levelsByClass[currentClassKey];
      const hex = encodeLevelsToHex(levels, cls.skills);
      return `${classPrefix(currentClassKey)}:${hex}`;
    }

    function setFromShareCode(code) {
      // Aceita formatos: "r:0a1b2c" ou "#r:0a1b2c"
      let raw = (code || "").trim();
      if (!raw) return false;

      // Remove # do início se existir
      raw = raw.replace(/^#/, "");

      // Valida formato: letra:hex
      const m = raw.match(/^([rbnwp]):([0-9a-fA-F]+)$/i);
      if (!m) {
        console.log("Import falhou - regex não bateu:", raw);
        return false;
      }

      const pref = m[1].toLowerCase();
      const hex = m[2].toLowerCase();

      const key = keyFromPrefix(pref);
      const cls = CLASSES[key];
      if (!cls) {
        console.log("Import falhou - classe não encontrada:", key);
        return false;
      }

      // decode
      levelsByClass[key] = decodeHexToLevels(hex, cls.skills);
      currentClassKey = key;

      // update UI select
      document.getElementById("classSelect").value = key;

      updateHeader();
      renderSkills();
      syncHash();
      persistLocal();
      return true;
    }

    async function doExport() {
      const code = getShareCode();
      try {
        await navigator.clipboard.writeText(code);
        showToast("Copiado: " + code);
      } catch (e) {
        window.prompt("Copie o código:", code);
      }
    }

    function doImport() {
      const input = window.prompt("Cole o código da build (ex: r:00000000):");
      if (!input) return;

      // Extrai código se for URL completa
      let code = input.trim();
      if (code.includes('#')) {
        code = code.split('#').pop();
      }

      console.log("Import tentando código:", code);

      const ok = setFromShareCode(code);
      if (!ok) {
        showToast("Código inválido! Use formato: r:00000000");
      } else {
        showToast("Build importada!");
      }
    }

    /* =========================
       URL hash + LocalStorage
    ========================= */
    function syncHash() {
      const code = getShareCode();
      if (location.hash.replace(/^#/, "") !== code) {
        history.replaceState(null, "", "#" + code);
      }
    }
    function loadFromHashIfAny() {
      const raw = (location.hash || "").replace(/^#/, "");
      if (!raw) return false;
      return setFromShareCode(raw);
    }

    function persistLocal() {
      try {
        const payload = { currentClassKey, levelsByClass };
        localStorage.setItem("talcalc_state_v1", JSON.stringify(payload));
      } catch (e) { }
    }
    function loadLocal() {
      try {
        const s = localStorage.getItem("talcalc_state_v1");
        if (!s) return false;
        const obj = JSON.parse(s);
        if (!obj || !obj.levelsByClass) return false;
        // merge safely
        for (const k of Object.keys(CLASSES)) {
          if (obj.levelsByClass[k]) {
            levelsByClass[k] = { ...levelsByClass[k], ...obj.levelsByClass[k] };
          }
        }
        if (obj.currentClassKey && CLASSES[obj.currentClassKey]) currentClassKey = obj.currentClassKey;
        return true;
      } catch (e) { return false; }
    }

    /* =========================
       Init
    ========================= */
    document.getElementById("classSelect").addEventListener("change", (e) => {
      currentClassKey = e.target.value;
      updateHeader();
      renderSkills();
      syncHash();
      persistLocal();
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      if (confirm("Resetar a classe atual?")) resetCurrent();
    });
    document.getElementById("exportBtn").addEventListener("click", doExport);
    document.getElementById("importBtn").addEventListener("click", doImport);

    (function init() {
      // prefer hash > local
      const fromHash = loadFromHashIfAny();
      if (!fromHash) {
        loadLocal();
        // if loaded local, reflect
        document.getElementById("classSelect").value = currentClassKey;
        syncHash();
      }
      updateHeader();
      renderSkills();
    })();
  </script>
</body>

</html>